(% extends "minimal.html" %)

(% block content %)

<div class="container-fluid">
    <div class="panel panel-default">
        <div class="row">
            <div class="col-sm"></div>
            <div class="col-sm text-center">
                <h2>Spectrum Values</h2>
            </div>
            <div class="col-sm"></div>
        </div>
        <hr>
        <div class="row">
            <div class="col-sm"></div>
            <div class="col-sm text-center">
                Universal Spectrum Identifier
                <br>
                ((usi))
                <br>
                <a href="/json/?usi=((usi))">Download peaks as json</a>
                <br>
                <a href="/csv/?usi=((identifier))">Download peaks as csv</a>
                <br>
                <a href="">Link back to source library</a>
            </div>
            <div class="col-sm"></div>
        </div>
        <hr>
        <div class="row">
            <div class="col-sm"></div>
            <div class="col-sm">
                <div class="row justify-content-center">
                    <div id="lorikeet"></div>
                </div>
            </div>
            <div class="col-sm"></div>
        </div>

        <hr>

        <div class="row">
            <div class="col-sm"></div>
            <div class="col-sm text-center">
                Spectrum SVG
            </div>
            <div class="col-sm"></div>
        </div>

        <div class="row">
            <div class="col-sm"></div>
            <div class="col-sm text-center">
                <img id="spectrumrender" src="/svg/?usi=((usi))&annotate_peaks">
            </div>
            <div class="col-sm"></div>
        </div>

        <div class="row">
            <div class="col-sm-3"></div>
            <div class="col-sm-6 text-center">
                <h2>Drawing Controls</h2>
                <br>
                <div class="form-group row">
                    <label for="annotate_peaks">Show Labels</label>
                </div>
                <div class="form-group row">
                    <div class="col">
                        <select id="annotate_peaks" class="form-control">
                            <option selected>Yes</option>
                            <option>No</option>
                        </select>
                    </div>

                    <div class="col">
                        <input type="text" id="annotate_threshold" class="form-control" placeholder="Label Threshold - Percent">
                    </div>

                </div>
                <div class="form-group row">
                    <div class="col">
                        <input type="text" id="annotate_precision" class="form-control" placeholder="Label decimal places">
                    </div>
                </div>
                <div class="form-group row">
                    <div class="col">
                        <input type="text" id="mz_min" class="form-control" placeholder="Min m/z">
                    </div>
                    <div class="col">
                        <input type="text" id="mz_max" class="form-control" placeholder="Max m/z">
                    </div>
                </div>
                <div class="form-group row">
                    <div class="col">
                        <input type="text" id="annotation_rotation" class="form-control" placeholder="Label rotation angle (70 default)">
                    </div>
                </div>
                <button class="btn btn-primary" onclick=updateFigure()>Update</button>
                <br>
                <br>
                <a id="controlsvgdownload" href="/svg/?usi=((usi))&annotate_peaks" download="((usi)).svg">
                    <button class="btn btn-primary" >Download SVG</button>
                </a>
                <a id="controlpngdownload" href="/png/?usi=((usi))&annotate_peaks" download="((usi)).png">
                    <button class="btn btn-primary" >Download PNG</button>
                </a>
            </div>
            <div class="col-sm-3"></div>
        </div>
        <hr>
        <div class="row">
                <div class="col-sm"></div>
                <div class="col-sm text-center">
                    QR Code
                </div>
                <div class="col-sm"></div>
        </div>
        <div class="row">
            <div class="col-sm"></div>
            <div class="col-sm text-center">
                <img src="/qrcode/?usi=((usi))"/>
            </div>
            <div class="col-sm"></div>
        </div>

</div>



<script type="text/javascript">

    $(document).ready(function () {

        /* Render the spectrum with the given options. */
        $("#lorikeet").specview({
            peaks: peaks,
            showIonTable: false,
            showViewingOptions: true,
            showOptionsTable: false,
            showSequenceInfo: false,
            labelImmoniumIons: false,
            labelPrecursorPeak: false,
        });

    });

    const peaks = ((peaks));
    const usi = '((usi))';

    function updateFigure() {
        let svg_url = "/svg/?usi=" + usi;
        let png_url = "/svg/?usi=" + usi;
        let draw_parameters = "";

        if($("#annotate_peaks").val() === "Yes"){
            draw_parameters += "&annotate_peaks"
        }
        if($("#annotate_threshold").val().length > 0){
            let annotate_threshold = parseFloat($("#annotate_threshold").val()) / 100;
            draw_parameters += `&annotate_threshold=${annotate_threshold}`;
        }
        if($("#mz_min").val().length > 0){
            let mz_min = $("#mz_min").val();
            draw_parameters += `&rescale&mz_min=${mz_min}`;
        }
        if($("#mz_max").val().length > 0){
            let mz_max = $("#mz_max").val();
            draw_parameters += `&rescale&mz_max=${mz_max}`;
        }
        if($("#annotation_rotation").val().length > 0){
            let annotation_rotation = $("#annotation_rotation").val();
            draw_parameters += `&annotation_rotation=${annotation_rotation}`;
        }
        if($("#annotate_precision").val().length > 0) {
            let annotate_precision = $("#annotate_precision").val();
            draw_parameters += `&annotate_precision=${annotate_precision}`;
        }

        alert(draw_parameters);
        $("#spectrumrender")[0].src = svg_url + draw_parameters;
        $("#controlsvgdownload")[0].href = svg_url + draw_parameters;
        $("#controlpngdownload")[0].href = png_url + draw_parameters;
    }
</script>

(% endblock %)
